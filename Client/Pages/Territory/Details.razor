@page "/Territory/Details/{TerritoryId:int}"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using TerritoryWeb.Shared.Territory
@using GoogleMapsComponents
@using GoogleMapsComponents.Maps
@inject HttpClient Http

<style>
    #map {
        height: 400px;
    }
</style>
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><NavLink href="/">Home</NavLink></li>
        <li class="breadcrumb-item"><NavLink href="/Territory">Territory</NavLink></li>
        <li class="breadcrumb-item active">Territory Details</li>
    </ol>
</nav>
<h2>Details</h2>
<EditForm Model="@td">
    <div class="row">
        <div class="col-sm">
            <div class="mb-3">
                <label>Territory Name</label>
                <InputText @bind-Value="td.TerritoryName" class="form-control" readonly />
            </div>
            <div class="mb-3">
                <label>City</label>
                <InputText @bind-Value="td.City" class="form-control" readonly />
            </div>
            <div class="mb-3">
                <label>Type</label>
                <InputText @bind-Value="td.TerritoryTypeStr" class="form-control" readonly />
            </div>
            <div class="mb-3">
                <label>Notes</label>
                <InputTextArea @bind-Value="td.Notes" class="form-control" readonly />
            </div>
            <h3>Doors Details</h3>
            Door Count: @td.DoorCount
            <NavLink href="@td.DoorsUrl" class="btn btn-outline-secondary"><i class="fa fa-address-book-o" aria-hidden="true"></i> View Territory Doors</NavLink>
        </div>
        <div class="col-sm">
            <div class="mb-3">
                <label>Assigned Publisher</label>
                <InputText @bind-Value="td.AssignedPublisher" class="form-control" readonly />
            </div>            
            <div class="mb-3">
                <label>Checked Out</label>
                <InputDate @bind-Value="td.CheckedOut" class="form-control" readonly />
            </div>            
            <div class="mb-3">
                <label>Checked In</label>
                <InputDate @bind-Value="td.CheckedIn" class="form-control" readonly />
            </div>            
            <div class="mb-3">
                <label>Last Checked In By</label>
                <InputText @bind-Value="td.LastCheckedInBy" class="form-control" readonly />
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-outline-secondary"><i class="fa fa-reply" aria-hidden="true"></i> Check Out</button>
                <button type="button" class="btn btn-outline-secondary"><i class="fa fa-share" aria-hidden="true"></i> Check In</button>
                <button type="button" class="btn btn-outline-secondary"><i class="fa fa-share-square-o" aria-hidden="true"></i> Share Territory</button>
            </div>
        </div>
        <div class="col-6">
            Map
            <GoogleMap @ref="@map1" Id="map1" Options="@mapOptions" OnAfterInit="@(async () => await OnAfterInitAsync())"></GoogleMap>
        </div>
    </div>
</EditForm>
@code {
    [Parameter]
    public int TerritoryId { get; set; }
    private TerritoryDetails td = new TerritoryDetails();

    //Map
    private GoogleMap map1;
	private MapOptions mapOptions;	
    private List<LatLngLiteral> path = new List<LatLngLiteral>();
    private Polygon polygon;

	protected override void OnInitialized()
	{
		mapOptions = new MapOptions()
		{
			Zoom = 13,
			Center = new LatLngLiteral()
			{
				Lat = 40.603629,
				Lng = -75.472518
			},
			MapTypeId = MapTypeId.Roadmap
		};
	}	
    protected override async Task OnInitializedAsync()
    {
        try
        {
            td = await Http.GetFromJsonAsync<TerritoryDetails>("Territory/GetTerritoryDetails/" + TerritoryId.ToString());
            
            //Convert TerritoryBounds to path
            if (td.TerritoryBounds.Count > 0)
            {
                foreach (var tb in td.TerritoryBounds)
                {
                    path.Add(new LatLngLiteral() { Lat = tb.GeoLat, Lng = tb.GeoLong });
                }                
            }
           
        }
        catch (AccessTokenNotAvailableException exception)
        {
            exception.Redirect();
        }
    }

    private async Task OnAfterInitAsync()
    {
        polygon = await Polygon.CreateAsync(map1.JsRuntime, new PolygonOptions() 
        {
            Map = map1.InteropObject
        });

        await polygon.SetPath(path);
        LatLngLiteral center = Common.Compute2DPolygonCentroid(path);
        if (center.Lat != 0)
        {
            await map1.InteropObject.SetCenter(center);
        };
    }
}